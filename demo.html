<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Demo - Eatinator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ios-blue': '#007AFF',
                        'ios-gray': '#8E8E93',
                        'ios-gray-2': '#AEAEB2',
                        'ios-dark-1': '#000000',
                        'ios-dark-2': '#1C1C1E',
                        'ios-dark-3': '#2C2C2E',
                        'ios-dark-4': '#3A3A3C',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .swiftui-card {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(84, 84, 88, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .swiftui-button {
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
        }
        
        .swiftui-button:active {
            transform: scale(0.96);
            opacity: 0.8;
        }
        
        .vote-button {
            background: rgba(58, 58, 60, 0.6);
            color: #AEAEB2;
            border: 1px solid rgba(84, 84, 88, 0.4);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .vote-button:hover {
            background: rgba(84, 84, 88, 0.6);
            color: #FFFFFF;
        }
    </style>
</head>
<body class="dark bg-ios-dark-1 text-white min-h-screen">
    <div class="min-h-screen p-4">
        <div class="max-w-md mx-auto">
            <!-- Header -->
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-white">Image Upload Demo</h1>
                <p class="text-ios-gray text-sm mt-1">Eatinator - Food Photo Feature</p>
            </div>

            <!-- Demo Menu Items -->
            <div class="space-y-4" id="menuContainer">
                <!-- Menu items will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Image upload configuration
        const IMAGE_CONFIG = {
            apiUrl: '/api/images.php',
            enabled: true,
            maxSize: 5 * 1024 * 1024, // 5MB
            allowedTypes: ['image/jpeg', 'image/png', 'image/webp'],
            timeout: 10000
        };

        // Demo menu data
        const demoMenuItems = [
            {
                dishName: "Spaghetti Carbonara, Parmesan, Bacon",
                menuType: "Menu",
                price: 12.50
            },
            {
                dishName: "Grilled Salmon, Lemon Herb Sauce, Vegetables",
                menuType: "Hit",
                price: 15.90
            },
            {
                dishName: "Vegetarian Buddha Bowl, Quinoa, Avocado",
                menuType: "Vegi",
                price: 11.20
            }
        ];

        // Generate a unique key for dish images
        function getImageKey(dishName, menuType, date) {
            return `img_${date}_${dishName.replace(/[^a-zA-Z0-9]/g, '_')}_${menuType.replace(/[^a-zA-Z0-9]/g, '_')}`;
        }

        // Upload image for a menu item
        async function uploadImage(dishName, menuType, file) {
            if (!IMAGE_CONFIG.enabled) {
                throw new Error('Image upload is disabled');
            }

            if (file.size > IMAGE_CONFIG.maxSize) {
                throw new Error('File too large. Maximum size is 5MB');
            }

            if (!IMAGE_CONFIG.allowedTypes.includes(file.type)) {
                throw new Error('Invalid file type. Only JPEG, PNG, and WebP are allowed');
            }

            const currentDate = new Date().toISOString().split('T')[0];
            const imageKey = getImageKey(dishName, menuType, currentDate);
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', imageKey);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), IMAGE_CONFIG.timeout);

                const response = await fetch(IMAGE_CONFIG.apiUrl, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Upload failed');
                }

                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Upload timeout');
                }
                throw error;
            }
        }

        // Get images for a menu item
        async function getImages(dishName, menuType) {
            if (!IMAGE_CONFIG.enabled) {
                return [];
            }

            const currentDate = new Date().toISOString().split('T')[0];
            const imageKey = getImageKey(dishName, menuType, currentDate);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), IMAGE_CONFIG.timeout);

                const response = await fetch(`${IMAGE_CONFIG.apiUrl}?key=${encodeURIComponent(imageKey)}`, {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    return data.success ? data.images : [];
                }
            } catch (error) {
                console.log('Failed to load images:', error);
            }

            return [];
        }

        // Handle camera/upload button click
        function handleImageUpload(dishName, menuType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const currentDate = new Date().toISOString().split('T')[0];
                const imageKey = getImageKey(dishName, menuType, currentDate);
                const button = document.querySelector(`[data-upload-key="${imageKey}"]`);
                
                if (button) {
                    button.innerHTML = '<span class="text-lg">‚è≥</span><span class="text-sm">Uploading...</span>';
                    button.disabled = true;
                }

                try {
                    await uploadImage(dishName, menuType, file);
                    
                    if (button) {
                        button.innerHTML = '<span class="text-lg">‚úÖ</span><span class="text-sm">Uploaded!</span>';
                        setTimeout(() => {
                            button.innerHTML = '<span class="text-lg">üì∑</span><span class="text-sm">Add Photo</span>';
                            button.disabled = false;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Failed to upload image: ' + error.message);
                    
                    if (button) {
                        button.innerHTML = '<span class="text-lg">üì∑</span><span class="text-sm">Add Photo</span>';
                        button.disabled = false;
                    }
                }
            };
            
            input.click();
        }

        // Show images modal
        async function showImages(dishName, menuType) {
            try {
                const images = await getImages(dishName, menuType);
                
                if (images.length === 0) {
                    alert('No photos available for this dish yet.');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };

                const content = document.createElement('div');
                content.className = 'bg-ios-dark-2 rounded-xl max-w-lg w-full max-h-96 overflow-y-auto';

                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-4 border-b border-ios-dark-4';
                header.innerHTML = `
                    <h3 class="text-white font-semibold">Photos: ${dishName}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-ios-gray-2 text-xl">√ó</button>
                `;

                const imageGrid = document.createElement('div');
                imageGrid.className = 'p-4 space-y-4';

                images.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'flex flex-col space-y-2';
                    imageItem.innerHTML = `
                        <img src="${image.url}" alt="${image.originalName}" 
                             class="w-full h-48 object-cover rounded-lg">
                        <div class="text-ios-gray-2 text-xs">
                            <div>Uploaded: ${image.timestamp}</div>
                        </div>
                    `;
                    imageGrid.appendChild(imageItem);
                });

                content.appendChild(header);
                content.appendChild(imageGrid);
                modal.appendChild(content);
                document.body.appendChild(modal);

            } catch (error) {
                console.error('Failed to load images:', error);
                alert('Failed to load images');
            }
        }

        // Generate image upload/view HTML for a menu item
        function generateImageHtml(dishName, menuType) {
            if (!IMAGE_CONFIG.enabled) {
                return '';
            }

            const currentDate = new Date().toISOString().split('T')[0];
            const imageKey = getImageKey(dishName, menuType, currentDate);

            return `
                <div class="border-t border-ios-gray border-opacity-20 pt-3 mt-3">
                    <div class="flex justify-between items-center">
                        <span class="text-ios-gray-2 text-sm font-medium">Photos:</span>
                        <div class="flex gap-2">
                            <button class="vote-button swiftui-button px-3 py-2 rounded-lg flex items-center gap-2" 
                                    onclick="handleImageUpload('${dishName.replace(/'/g, "\\'")}', '${menuType}')"
                                    data-upload-key="${imageKey}">
                                <span class="text-lg">üì∑</span>
                                <span class="text-sm font-medium">Add Photo</span>
                            </button>
                            <button class="vote-button swiftui-button px-3 py-2 rounded-lg flex items-center gap-2" 
                                    onclick="showImages('${dishName.replace(/'/g, "\\'")}', '${menuType}')">
                                <span class="text-lg">üñºÔ∏è</span>
                                <span class="text-sm font-medium">View Photos</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create menu item HTML
        function createMenuItemHtml(item) {
            const priceHtml = item.price > 0 ? `<span class="text-ios-blue text-sm font-semibold">CHF ${item.price.toFixed(2)}</span>` : '';
            const menuTypeBadge = `<span class="bg-ios-dark-4 text-ios-gray-2 text-xs px-2 py-1 rounded-full">${item.menuType}</span>`;
            const imageHtml = generateImageHtml(item.dishName, item.menuType);

            return `
                <div class="swiftui-card p-4 rounded-xl">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-white flex-1 pr-3 text-lg leading-tight">${item.dishName}</h3>
                        ${priceHtml}
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${menuTypeBadge}
                    </div>
                    ${imageHtml}
                </div>
            `;
        }

        // Initialize demo
        function initDemo() {
            const container = document.getElementById('menuContainer');
            container.innerHTML = demoMenuItems.map(item => createMenuItemHtml(item)).join('');
        }

        // Start demo when page loads
        document.addEventListener('DOMContentLoaded', initDemo);
    </script>
</body>
</html>